var express = require('express');
var app = express();
const util = require('util');
const exec = util.promisify(require('child_process').exec);

app.use(express.json());

app.post('/', async function (req, res) {
    console.log("Executing deployment...");

    try {
        const { stdout, stderr } = await exec(
            "ansible-pull -U git@github.com:<GitHubUser>/<repo-name>.git <playbook>.yml"
        );

        console.log("stdout:", stdout);
        if (stderr) console.error("stderr:", stderr);

        res.json({ success: true, output: stdout });
    } catch (error) {
        console.error("Execution error:", error);
        res.status(500).json({ success: false, error: error.message });
    }
});

app.listen(8080, '127.0.0.1', () => {
    console.log("Webhook running on http://127.0.0.1:8080");
});

